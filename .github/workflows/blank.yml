name: iPerf3 Speedtest Manual

on:
  workflow_dispatch:

jobs:
  iperf3-test:
    name: Run iPerf3 Speedtest
    runs-on: ubuntu-latest

    env:
      SERVER_IP: ${{ secrets.IPERF3_SERVER_IP }}
      SERVER_PORT: ${{ secrets.IPERF3_SERVER_PORT }}
      IPERF3_PATH: /usr/local/iperf3

    steps:
      - name: Cache iPerf3 binary & libs
        id: cache-iperf3
        uses: actions/cache@v4
        with:
          path: ${{ env.IPERF3_PATH }}
          key: iperf3-cache

      - name: Install iPerf3 if not cached
        if: steps.cache-iperf3.outputs.cache-hit != 'true'
        run: |
          echo "‚öôÔ∏è Installing iPerf3 (first time only)..."
          sudo apt-get update -qq
          sudo apt-get install -y iperf3
          sudo mkdir -p $IPERF3_PATH/bin $IPERF3_PATH/lib
          sudo cp $(which iperf3) $IPERF3_PATH/bin/
          # Copy all library dependencies
          ldd $(which iperf3) | awk '{print $3}' | grep -v '(' | xargs -I{} sudo cp {} $IPERF3_PATH/lib/
          echo "‚úÖ Cached iPerf3 binary and dependencies."

      - name: Verify cache content
        run: |
          echo "üì¶ Cached files:"
          ls -lh $IPERF3_PATH/bin
          ls -lh $IPERF3_PATH/lib | head

      - name: Test Upload (GitHub ‚Üí Server)
        run: |
          echo "üöÄ Testing upload (GitHub ‚Üí Server)"
          export LD_LIBRARY_PATH=${{ env.IPERF3_PATH }}/lib
          ${{ env.IPERF3_PATH }}/bin/iperf3 -c $SERVER_IP -p $SERVER_PORT -f m -t 10 -R || true

      - name: Test Download (Server ‚Üí GitHub)
        run: |
          echo "‚¨áÔ∏è Testing download (Server ‚Üí GitHub)"
          export LD_LIBRARY_PATH=${{ env.IPERF3_PATH }}/lib
          ${{ env.IPERF3_PATH }}/bin/iperf3 -c $SERVER_IP -p $SERVER_PORT -f m -t 10 || true

      - name: Summary
        run: |
          echo "‚úÖ iPerf3 test done"
          echo "Server: $SERVER_IP:$SERVER_PORT"
          echo "Check logs above for upload/download speed"
